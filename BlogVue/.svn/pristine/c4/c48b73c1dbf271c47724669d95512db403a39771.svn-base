<template>
<div class="layout-bd-right">
  <div class="layout-main">
    <div class="main_container">
      <div class="path-nav">
        <h1><Icon type="location"></Icon>{{discussionInfo.name}} > 查看</h1>
        <h1 style="float:right"><img @click="goBack()" src=""> </h1>
      </div>
      <div class="main-bd">
        <div class="wrap-main">
          <div class="main-box">
            <div class="main-contents1">
              <div v-html="discussionInfo.content" class="cccimg"></div>
            </div>
            <div class="tea-say-box"><span>教师总结</span></div>
            <div class="tea-say">
              <Input type="textarea" placeholder="老师评语，最多不可以超过200个字" v-model="discussionInfo.teaSay" :rows="3" :maxlength="200" :autosize="{maxRows:3,minRows: 3}"/>
              <div><Button size="small" @click="commitDiscussion()"  class="enter_btn" style="background: rgb(133, 189, 250);color:white;width: 60px;">提交</Button></div>
              <div class="clear"></div>
            </div>

            <div  class="list-box"><span>讨论列表(共{{total}}条)</span> <Button style="background: rgb(51,168,235);color: white;" @click="reflushList" class="enter_btn">刷新列表</Button></div>
            <div class="main-contents1">
                <div class="table-bottom-box">
                  <div class="stu-discussion-detail">
                      <ul>
                        <li style="list-style-type:none; border-bottom:1px solid #eee" v-for="(item,index) in stuDiscussList" :key="index">
                          <!-- <span>&nbsp;&nbsp;{{item.name}}</span> -->
                          <div class="stairs-cls">{{change(index+1)}}楼：</div>
                          <div style="margin-top:10px;margin-bottom:10px;margin-left:3em;">
                            <!-- 第一排 -->
                            <div style="margin-bottom: 10px;margin-top: 10px;font-size:18px"> 
                              <div style="display:inline-block;margin: auto 0;width:13rem;font-size:18px">{{item.stuName}}</div>
                              学分: <div :id="'id'+item.id" style="display:inline-block;margin: auto 0;width:5rem;border: 1px solid  rgb(51,168,235);font-size:18px;padding-left: 10px;padding-right: 10px;color: rgb(51,168,235);margin-right: 50px;text-align-last: center;">  {{item.score}}分</div>
                              <div style="display:inline-block;margin: auto 0;width:3rem;"><Icon @click="addScore(item)" size="32" color=" rgb(51,168,235)" type="ios-add-circle-outline" /></div>
                              <div style="display:inline-block;margin: auto 0;width:3rem;"><Icon @click="subtractScore(item)" size="32" color=" rgb(51,168,235)" type="ios-remove-circle-outline" /></div>
                              <div style="display:inline-block;margin: auto 0;width:30px;font-size:18px;float: right;padding-top:4px;">{{item.thumbsUpNum}}</div>
                              <div style="display:inline-block;margin: auto 0;width:30px;font-size:18px;float: right;"> 
                                <div style="display:flex;justify-content: flex-end;">
                                  <Button  type="primary">评论</Button> 
                                  <img @click="thumb(item)" style="padding-top: 8px;margin-left: 10px;" :src="(item.isThumbUp==1 && CurUser.curUser.id==item.userId)?'static/img/red-zan.png':'static/img/white-zan.png'"  size="32" :id="'thumb'+item.id" type="md-thumbs-up" />
                                </div> 
                              </div>
                            </div>
                            <!-- 第二排 -->
                            <div style="position:relative">
                              <div style="font-size:14px;margin-right: 200px;margin-bottom:20px;">{{item.stuDiscussContent}}</div>
                              <div style="float:right;margin-right: 15px;">{{item.createDate}}发布</div>
                              <div class="clear">
                              </div>
                              <div style="position:absolute;left: -42px;top: 40px;">
                                 <Button  icon="md-arrow-dropup" type="primary" @click="hideReview(item,index)">收起</Button> 
                              </div>
                            </div>                        
                          </div>

                          <div style="height:134px;width:calc(100%);border:1px solid #eee;" :class="'re'+index">
                            <ul>
                              <li>
                                <span>测飒：测试彩色</span>
                              </li>
                            </ul>
                          </div>

                        </li>
                      </ul>
                    </div>
                <!-- <Table :columns="columns" :data="stuDiscussList" ref="table"></Table> -->
                <div class="mt10 v-tr page-wrap" style="bottom:-25px;">
                  <Page class="fr" :total="total" :page-size="count" :page-size-opts="[20,40,100]"  @on-page-size-change="pageSizeUpdate"
                    placement="top" @on-change="pageUpdate" show-sizer show-total>
                  </Page>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</div>

</template>


<script>
import myStorge from "../utils/localStorge.js";
import "../../static/plugins/ztree/jquery.ztree.all.min.js";
require("../../static/plugins/ztree/zTreeStyle.css");
export default {
  data() {
    return {
      discussionInfo: myStorge.get("discussionInfo"),
      page: 0,
      count: 20,
      total: 0,
      CurUser: {
        curUser: {
          id: 1
        }
      },
      //discussionInfo:{},
      stuDiscussList: [
        {
          id: 1,
          stuName: "hhh",
          thumbsUpNum: 1,
          score: 2,
          isThumbUp: 1,
          createDate: "2019-01-01 14:30:20",
          stuDiscussContent: "hhg",
          isShow: true
        },
        {
          id: 2,
          stuName: "dd",
          thumbsUpNum: 1,
          score: 3,
          isThumbUp: 1,
          createDate: "2019-01-01 14:30:20",
          stuDiscussContent: "hhg",
          isShow: true
        },
        {
          id: 3,
          stuName: "dd",
          thumbsUpNum: 1,
          score: 3,
          isThumbUp: 1,
          createDate: "2019-01-01 14:30:20",
          stuDiscussContent: "hhg",
          isShow: true
        }
      ]
    };
  },
  created: function() {},
  mounted: function() {
    var _this = this;
    // _this.getStuDiscussions();
  },
  methods: {
    hideReview(item, index) {
      const _this = this;
      const dom = document.querySelector(".re" + index);
      if (item.isShow) {
        $(dom).hide("slow");
        item.isShow = false;
      } else {
        $(dom).show("slow");
        item.isShow = true;
      }
      console.log(dom);
    },
    pageUpdate: function(page) {
      var _this = this;
      _this.page = page - 1;
      _this.getStuDiscussions();
    },
    pageSizeUpdate: function(size) {
      var _this = this;
      _this.count = size;
      _this.getStuDiscussions();
    },
    change: function(index) {
      var _this = this;
      // return _this.$utils.numberConvertToUppercase(index);
      return String.fromCharCode(index + 64);
    },
    goBack: function() {
      var _this = this;
      var path = _this.routerCfg.pathById(_this.routerCfg.MY_DISCUSSION_ID);
      _this.$router.push(path);
    },
    commitDiscussion: function() {
      var _this = this;
      $.post(
        _this.APIConfig.Discussion.UpdateTeaSay,
        { teaSay: _this.discussionInfo.teaSay, id: _this.discussionInfo.id },
        function(resp) {
          if (resp.code == 0) {
            _this.$Message.info("老师总结提交成功");
          } else {
            _this.$Message.info(resp.msg);
          }
        },
        "json"
      ).error(function() {
        _this.$Message.info("提交失败");
      });
    },
    // getDiscussionInfo:function(){
    //   var _this=this;
    //      $.get(
    //     _this.APIConfig.Discussion.GetDiscussionInfo,
    //     {"id":_this.discussionId},
    //     function(resp){
    //       console.log(resp)
    //       if(resp.code==0){
    //           _this.discussionInfo=resp.data;
    //           $("#contentBody").html(_this.discussionInfo.content)
    //       }else{
    //         _this.$Message.info(resp.msg)
    //       }
    //     },"json"
    //   ).error(function(){
    //     _this.$Message.info("出错了");
    //   })
    // },
    getStuDiscussions: function() {
      var _this = this;
      $.get(
        _this.APIConfig.StuDiscussion.GetStuDiscusses,
        {
          discussId: _this.discussionInfo.id,
          page: _this.page,
          size: _this.count,
          sort: "create_date"
        },
        function(resp) {
          if (resp.code == 0) {
            var data = resp.data.stuDiscusses;
            _this.$nextTick(function() {
              _this.stuDiscussList = data;
            });
            _this.total = Number(resp.data.totalElements);
          } else {
            _this.$Message.info(resp.msg);
          }
        },
        "json"
      ).error(function() {
        _this.$Message.info("出错了");
      });
    },
    addScore: function(item) {
      var _this = this;
      item.score = Number(item.score) + 1;
      _this.updateStuDiscuss(item);
    },
    subtractScore: function(item) {
      var _this = this;
      var score = Number(item.score);
      if (score > 0) {
        item.score = score - 1;
        _this.updateStuDiscuss(item);
      }
    },
    thumb: function(item) {
      var _this = this;
      if (item.isThumbUp == 1) {
        item.isThumbUp = 0;
        _this.updateThumb(item);
      } else if (item.isThumbUp == 0) {
        item.isThumbUp = 1;
        _this.updateThumb(item);
      } else {
        _this.addThumb(item);
      }
    },
    updateStuDiscuss: function(item) {
      var _this = this;
      $.post(
        _this.APIConfig.StuDiscussion.UpdateStuDiscuss,
        {
          id: item.id,
          stuId: item.stuId,
          stuName: item.stuName,
          stuClassId: item.stuClassId,
          stuClassName: item.stuClassName,
          courseId: item.courseId,
          courseName: item.courseName,
          chapterId: item.chapterId,
          chapterName: item.chapterName,
          discussId: item.discussId,
          stuDiscussContent: item.stuDiscussContent,
          score: item.score,
          thumbsUpNum: item.thumbsUpNum,
          createDate: item.createDate,
          stuStates: item.stuStates,
          discussName: item.discussName
        },
        function(resp) {
          if (resp.code == 0) {
            _this.getStuDiscussions();
            //var s=$("#id"+item.id).text(Number(Number(item.score))+"分");
          } else {
            _this.$Message.info(resp.msg);
          }
        },
        "json"
      );
    },
    updateThumb: function(item) {
      var _this = this;
      $.post(
        _this.APIConfig.Thumb.UpdateThumb,
        {
          id: item.tId,
          isThumbUp: item.isThumbUp,
          stuDiscussId: item.id,
          userId: item.userId,
          createDate: item.tCd
        },
        function(resp) {
          if (resp.code == 0) {
            _this.getStuDiscussions();
          } else {
            _this.$Message.info(resp.msg);
          }
        },
        "json"
      );
    },
    addThumb: function(item) {
      var _this = this;
      $.post(
        _this.APIConfig.Thumb.InsertThumb,
        {
          isThumbUp: 1,
          stuDiscussId: item.id
        },
        function(resp) {
          if (resp.code == 0) {
            _this.getStuDiscussions();
          } else {
            _this.$Message.info(resp.msg);
          }
        },
        "json"
      );
    },
    reflushList: function() {
      var _this = this;
      _this.page = 0;
      _this.getStuDiscussions();
    }
  }
};
</script>
<style lang="scss" scoped>
@import "../../static/style/oldstyle.scss";

.wrap-main .main-box .main-contents1 {
  padding: 15px;
  min-width: 760px;
  min-height: 30%;
  position: relative;
}
.wrap-main .main-box .tea-say {
  padding: 15px;
  min-width: 760px;
  min-height: 12%;
  height: auto !important;
  height: 500px;
  position: relative;
  background: #fff;
  border: 1px solid #eee;
  border-radius: 4px;
  box-sizing: border-box;
  margin-bottom: 15px;
  word-wrap: break-word;
}

.wrap-main .main-box .main-contents1 {
  background: #fff;
  border: 1px solid #eee;
  border-radius: 4px;
  box-sizing: border-box;
  margin-bottom: 15px;
}

.enter_btn {
  float: right;
  overflow: hidden;
}
.clear {
  clear: both;
  font-size: 0;
  height: 1%;
}
.stu-discussion-detail {
  margin-bottom: 15px;
}
.tea-say-box {
  // background:url(../../static/img/tea-say.png) 0px 5px  no-repeat;
  margin-bottom: 10px;
  text-align: left;
  line-height: 30px;
  span {
    padding-left: 30px;
    font-size: 20px;
  }
}
.list-box {
  // background:url(../../static/img/say-list.png) 0px 5px no-repeat;
  margin-bottom: 10px;
  text-align: left;
  line-height: 30px;
  span {
    padding-left: 30px;
    font-size: 20px;
  }
}
* /deep/.ivu-input {
  border: 0px solid #fff;
}
.stairs-cls {
  display: inline-block;
  //float:left;
  font-size: 18px;
  color: rgb(51, 168, 235);
}
* /deep/.cccimg {
  img {
    max-width: 100%;
  }
  video {
    max-width: 100%;
    min-width: 246px;
    min-height: 148px;
  }
}
</style>