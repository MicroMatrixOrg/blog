<!--
 * @Author: 夏建设
 * @pageName: 'Ztree  树'
-->

<!--
getSelected 
params 参数1：要返回的节点
        参数2 返回该树的id
        参数3 返回（1、添加 2、修改）
-->

<template>
    <div class="zTreeDemoBackground left">
        <ul :id = "id" class="ztree"></ul>
    </div>
</template>

<script>
let doman = location.host; //获取当前的主机和端口
require("../../../static/plugins/ztree/zTreeStyle.css");
if (doman.indexOf("hsjy") > -1)
  require("../../../static/plugins/ztree/zTreeStyl.hsjy.css");
import "../../../static/plugins/ztree/jquery.ztree.all.min.js";
export default {
  props: {
    id: String,
    TreeSetting: Object,
    zNodes: Array, //整个树的节点
    sNodes: Array //已勾选的节点
  },
  data() {
    return {
      selectedNodes: this.sNodes,
      setting: this.TreeSetting,
      nodes: this.zNodes,
      beforeRemoveFlag: false,
      selectedNode: {},
      selectedNodeId: -1
    };
  },
  mounted() {
    const _this = this;
    _this.setGroupTree();
  },
  updated() {},
  beforeDestory() {
    this.destoryTree();
  },
  watch: {},
  methods: {
    setGroupTree() {
      //赋值树，所有的设置和志传入都在该函数中设置
      const _this = this;
      _this.nodes = _this.deepCopy(_this.zNodes);
      _this.setting.check.chkboxType = { Y: "ps", N: "ps" };

      _this.setting.edit.enable = false; //关闭移动统一的

      _this.setting.callback.onCheck = (event, treeId, treeNode, clickFlag) => {
        var zTree = $.fn.zTree.getZTreeObj(treeId);
        _this.selectedNode = treeNode;
        _this.selectedNodeId = treeId;
        if (_this.setting.check.enable) {
          // _this.selectedNodes = zTree.getCheckedNodes(true);
          _this.getNodeData(treeNode);

          _this.$emit("getSelected", _this.selectedNodes, treeId);
          // _this.$emit("getSelected", zTree.getCheckedNodes(true), treeId);
          if (zTree.getCheckedNodes(false).length == 0) {
            _this.$emit("isAll", true);
          } else if (zTree.getCheckedNodes(true).length == 0) {
            _this.$emit("isAll", false);
          }
        } else {
          _this.$emit("getSelected", treeNode, treeId);
        }

        // _this.cancelSelected(treeNode);
      };

      _this.setting.callback.onClick = (e, treeId, treeNode) => {
        var zTree = $.fn.zTree.getZTreeObj(treeId);
        zTree.checkNode(treeNode, !treeNode.checked, true);
        // zTree.expandNode(treeNode);
        _this.selectedNode = treeNode;
        _this.selectedNodeId = treeId;
        if (_this.setting.check.enable) {
          _this.getNodeData(treeNode);

          _this.$emit("getSelected", _this.selectedNodes, treeId);
          // _this.$emit("getSelected", zTree.getCheckedNodes(true), treeId);
          if (zTree.getCheckedNodes(false).length == 0) {
            _this.$emit("isAll", true);
          } else if (zTree.getCheckedNodes(true).length == 0) {
            _this.$emit("isAll", false);
          }
        } else {
          _this.$emit("getSelected", treeNode, treeId);
        }
      };

      if (typeof _this.nodes[0] != "undefined") {
        // var nodes = _this.$utils.openFistNode(_this.nodes[0]);
        var nodes = _this.$utils.openFistNode(_this.nodes);
      }
      console.log($.fn.zTree);
      $.fn.zTree.init($("#" + _this.id), _this.setting, _this.nodes);
    },

    //获取节点路径
    getNodePath(Node) {
      var _this = this;
      // var listNode = Node.getPath();
      var treeObj = $.fn.zTree.getZTreeObj(_this.id);
      var node = treeObj.getNodeByParam("id", Node.id, null);
      var listNode = node.getPath();
      var path = "";
      for (let i = 0; i < listNode.length; i++) {
        path += listNode[i].name + "-";
      }
      path = path.substring(0, path.length - 1);
      return path;
    },

    //获取点击的数据()
    getNodeData(treeNode) {
      var _this = this;
      if (
        _this.setting.check.chkStyle == "radio" &&
        !treeNode.isParent &&
        !treeNode.nocheck
      ) {
        if (!treeNode.checked) {
          _this.selectedNodes.splice(0, 1, treeNode);
        }
      } else {
        if (!treeNode.isParent && !treeNode.nocheck) {
          var index = _this.selectedNodes.findIndex(x => x.id == treeNode.id);
          if (index != -1) {
            if (!treeNode.checked) {
              _this.selectedNodes.splice(index, 1);
            }
          } else {
            if (treeNode.checked) {
              _this.selectedNodes.push(treeNode);
            }
          }
        }
      }
      if (
        treeNode.isParent &&
        treeNode.children.length != 0 &&
        !treeNode.nocheck
      ) {
        for (var i = 0; i < treeNode.children.length; i++) {
          _this.getNodeData(treeNode.children[i]);
        }
      }
    },
    //取消勾选的节点
    cancelSelected(treeNode) {
      var _this = this;
      if (!treeNode.isParent) {
        treeNode.checked = false;
      }
      if (
        treeNode.isParent &&
        treeNode.children.length != 0 &&
        !treeNode.nocheck
      ) {
        for (let i = 0; i < treeNode.children.length; i++) {
          _this.getNodeData(treeNode.children[i]);
        }
      }
    },
    //初始化勾选节点
    selectedTheFirstNode(node) {
      const _this = this;
      $.fn.zTree.init($(this.id), _this.setting, _this.nodes);
      var zTree = $.fn.zTree.getZTreeObj(this.id);

      var node = zTree.getNodeByParam("id", node.id);
      zTree.selectNode(node); //根据该节点选中
    },
    destoryTree() {
      $.fn.zTree.destroy(this.id);
    },
    //勾选全部节点
    checkAllNodes(value) {
      //此处勾选全选和取消全选（设计好搞事情）
      const _this = this;
      var zTree = $.fn.zTree.getZTreeObj(_this.id);
      zTree.checkAllNodes(value);
      var temp = zTree.getCheckedNodes(value);
      for (let i = 0; i < temp.length; i++) {
        if (temp[i].children.length == 0) {
          _this.getNodeData(temp[i]);
        } else {
          continue;
        }
      }
      _this.$emit("getSelected", _this.selectedNodes, _this.id);
    },
    //修改节点信息(将修改的节点数据同步到被修改的数据上)
    editNode(treeNode) {
      const _this = this;
      var zTree = $.fn.zTree.getZTreeObj(_this.id);
      var editNode = zTree.getNodeByParam("id", treeNode.id);
      for (let i in treeNode) {
        if (i == "children") {
          continue;
        }
        editNode[i] = treeNode[i];
      }
      _this.$nextTick(() => {
        zTree.selectNode(editNode);
        _this.$emit("getSelected", editNode, _this.id, 2);
        zTree.updateNode(editNode);
      });
    },

    //删除节点
    remove(treeNode) {
      var _this = this;
      var zTree = $.fn.zTree.getZTreeObj(_this.id);
      if (treeNode.isParent) {
        zTree.removeChildNodes(treeNode);
        // zTree.removeNode(treeNode, true);
      } else {
        zTree.removeNode(treeNode, true); //树视图上删除
      }

      var parentNode = treeNode.getParentNode();

      if (parentNode.children.length == 0) {
        parentNode.isParent = false;
        zTree.updateNode(parentNode);
        zTree.selectNode(parentNode);
        _this.$emit("getSelected", parentNode, _this.id);
      }
    },
    //获取该节点的父节点
    getParentNode(treeNode) {
      return treeNode.getParentNode();
    },
    //添加节点（暂时不需要）
    add(sNode, addNode) {
      var _this = this;
      var zTree = $.fn.zTree.getZTreeObj(_this.id);

      sNode.isParent = true; //手动改变一下是否为父节点的属性

      var newNode = zTree.addNodes(sNode, -1, addNode, true);

      zTree.selectNode(sNode);
      _this.$emit("getSelected", sNode, _this.id, 1);
      zTree.updateNode(sNode);
    },

    deepCopy(obj) {
      const _this = this;
      var result = Array.isArray(obj) ? [] : {};
      for (let key in obj) {
        if (obj.hasOwnProperty(key)) {
          if (typeof obj[key] === "object" && obj[key] !== null) {
            result[key] = _this.deepCopy(obj[key]); //递归复制
          } else {
            result[key] = obj[key];
          }
        }
      }
      return result;
    }
  }
};
</script>


<style lang="scss" scoped>
* /deep/ .node_name {
  font-size: 10pt;
}
</style>
