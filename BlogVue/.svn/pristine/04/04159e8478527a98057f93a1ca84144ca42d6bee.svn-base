<template>
    <div class="main-box">
        <div class="main-content">
          <div class="other-contents">
            <header style="display: flex;justify-content: space-between;">
                <div>
                    <span style="font-size:18px;">发布管理</span> > <span style="font-size:16px;">{{editDisc.name}}</span> > <span style="font-size:16px;">查看详情</span>
                </div>
                <Button @click="goback()" type="primary" style=" display: inline-block;float:right;margin:0 12px;">返回</Button>
            </header>
            <footer>
              <header style="display: flex;background:#e9e9e9;min-height: 50px;">
                <div style="padding: 15px 0;min-width: 125px;text-align:center;cursor:pointer;" :class="[tabName == index ? 'activeClass' : '']"  v-for="(item,index) in classes" :key="index" @click="tabName = index;showStureview(item,index)" v-if="editDisc.courseId">{{item.className}}</div>
                <div style="padding: 15px 0;min-width: 125px;text-align:center;cursor:pointer;" :class="[tabName == index ? 'activeClass' : '']"  v-for="(item,index) in classes" :key="index" @click="tabName = index;showStureview(item,index)" v-if="!editDisc.courseId">{{editDisc.gradeName + item.className}}</div>
                
              </header>
              <section>
                <header>
                  <div style="padding: 0 10px;">
                    <div style="border-bottom: 2px solid #3587FF;display:inline-block;margin:10px 0 0;padding-bottom:10px;font-size:16px;cursor: context-menu;">讨论主题:{{editDisc.name}}</div>
                  </div>
                  <div style="border-top:1px solid #eee;padding:10px;">
                    <!-- <p style="font-size:16px;">请根据下面图片中所列出的讨论内容完成今天的讨论主题:{{editDisc.name}}</p> -->
                    <div style="margin-bottom:20px;">{{editDisc.content}}</div>
                    <div style="display:inline-block;height:100px;width:150px;" v-for="(item,index) in discFiles.photos" :key="item.webUrl + index">
                      <img :src="item.webUrl" alt="" style="height:100px;width:150px;object-fit:contain;"  @click="showImg(item.webUrl)">
                    </div>
                    <div style="display:inline-block;height:100px;width:150px;" v-for="(item,index) in discFiles.videos" :key="item.webUrl + index">
                      <video style="height:100%;width:100%"  :src="typeof item.webUrl =='undefined' ? '' : item.webUrl" controls>Your browser can't support  Video</video>
                    </div>
                    <div style="display:inline-block;height:100px;width:300px;" v-for="(item,index) in discFiles.audios" :key="item.webUrl + index">
                      <audio  style="height:100%;width:100%;padding-bottom: 20px;"  controls :src="typeof item.webUrl =='undefined' ? '' : item.webUrl">Your browser can't support  Audio</audio>
                    </div>                  

                  </div>
                </header>
                <footer>
                  <div style="padding: 0 10px;">
                    <div style="border-bottom: 2px solid #3587FF;display:inline-block;margin:10px 0 0;padding-bottom:10px;font-size:16px;cursor: context-menu;">教师总结</div>
                  </div>
                  <div style="border-top:1px solid #eee;padding:10px;">
                    <div style="margin-top:10px;">
                      <Input v-model="teaSay" type="textarea" :autosize="{minRows: 4,maxRows: 5}" placeholder="" :disabled="editDisc.states == 2"/>
                    </div>
                    <div style="text-align:end;margin-top:10px;" v-show="editDisc.states == 1">
                      <Button type="primary" @click="teacherSummarization" style="vertical-align: top;">提交</Button>
                    </div>
                  </div>
                </footer>
              </section>
              <footer>
                <header style="padding: 10px;">
                  <div style="display:flex;">
                    <div style="border-bottom: 2px solid #3587FF;display:inline-block;margin:10px 0 0;padding-bottom:10px;font-size:16px;cursor: context-menu;">讨论区</div>
                    <div style="font-size: 14px;margin: 6px 0px 0px 20px;padding: 0 10px;border: 1px solid #6BAD18;cursor: context-menu;line-height: 32px;height: 32px;color: #6BAD18;display: inline-block;border-radius: 7px;"><span>参与:&nbsp;{{partNum}}人</span></div>
                    <div style="font-size: 14px;margin: 6px 0px 0px 20px;padding: 0 10px;border: 1px solid #EF433F;cursor:pointer;line-height: 32px;height: 32px;color: #EF433F;display: inline-block;border-radius: 7px;" @click="noPartIn = true"><span>未参与:&nbsp;{{dontPartNum}}人</span></div>
                  </div>
                  <div v-show="editDisc.states == 1">
                      <div style="border-top:1px solid #eee;padding-top:20px;">
                        <span style="vertical-align: top;font-size:16px;">发表观点:</span>
                        <div style="display:inline-block;width: calc(100% - 80px);">
                          <Input v-model="teaViewpointer" type="textarea" :autosize="{minRows: 4,maxRows: 5}" placeholder="" />
                        </div>
                      </div>
                      <div  style="text-align:end;margin-top:10px;">
                        <!-- <fileupload style="display:inline-block;text-align: center; width: calc(100% - 126px);"  ref="fileUpload" @fileIds="getFileIds"  @pics="getFiles"></fileupload> -->
                        <fileupload style="display:inline-block;text-align: center; width: calc(100% - 126px);"  ref="fileUpload" @fileIds="getFileIds"  @pics="getFiles" @isUpload = 'studentUpload'></fileupload>
                        <Button type="primary" @click="commitTeaDisc" :disabled="viewPointer">提交</Button>
                      </div>
                  </div>
                </header>
                <section style="margin-top:40px;padding: 0 10px;">
                  <p style="border-bottom: 1px solid #eee;margin-bottom:10px;"><span style="font-size:16px;">讨论列表</span><span style="font-size:14px;"> (共{{msgTotal}}条)</span> <Button type="text" style="float: right;color:#3882EB;cursor:pointer;font-size:14px;" @click="refresh()">刷新</Button></p>
                  <div v-for="(item,index) in stuDiscussList" style="position:relative;margin-bottom:20px;padding-bottom:20px;padding-left: 20px;border-bottom:1px solid #eee;" :key="index">
                    <p style="margin-bottom: 10px;">{{item.stuName}}</p>
                    <div>
                      <div style="display:inline-block;" v-for="(item2,index2) in item.fileList" :key="index2">
                        <img :src="item2.url" alt="" style="height:100px;width:150px;object-fit:contain;" v-if="item2.fileType == 1"  @click="showImg(item2.url)">
                        <video style="height:100px;width:250px;"  :src="typeof item2.url =='undefined' ? '' : item2.url" controls v-if="item2.fileType == 2">Your browser can't support  Video</video>
                        <audio  style="height:100px;width:250px;padding-bottom: 20px;"  controls :src="typeof item2.url =='undefined' ? '' : item2.url" v-if="item2.fileType == 3">Your browser can't support  Audio</audio>
                      </div>
                    </div>
                    <p style="margin-bottom: 10px;">{{item.stuDiscussContent}}</p>
                    <p style="display:flex;justify-content: space-between;margin-bottom:10px;"><span>{{item.createDate}}</span> <span style=""><div style="display:inline-block;cursor:pointer;" @click="commentFlag = true;setStu(item)">评论</div><div style="display:inline-block;margin-left:10px;"><i  :class="[item.isThumbUp ? 'thumbs-active':'','fa', 'fa-thumbs-o-up']" style="margin-right:5px;font-size: 20px;cursor:pointer;" @click="thumbUp(item,index)"></i>{{item.thumbsUpNum}}</div></span></p>
                    <div style="position:absolute;right:10px;cursor:pointer;z-index:2;" @click="hideReview(item,index)" v-if="item.reviewDis.length != 0">
                      <span>{{item.isShow ? '收起' : '展开'}} </span>
                    </div>
                    <div style="height:134px;width:calc(100%);background-color:#F6F6F6;padding:5px 10px;overflow: auto;" :class="'re'+index" v-if="item.reviewDis.length != 0">
                      <ul>
                        <li>
                          <p style="margin-bottom:10px;cursor:pointer;" v-for="(item1,index1) in item.reviewDis" :key="index1" @click="ringSomeone(item1)" v-if="item1.reviewedName==null"><span>{{item1.name}}:</span>{{item1.content}}</p>              
                          <p v-else @click="ringSomeone(item1)" style="cursor:pointer;margin-bottom:10px;">{{item1.name}}{{item1.type==0?'同学':'老师'}} 回复  {{item1.reviewedName}}{{item1.reviewedType==0?'同学':item1.reviewedType==1?'老师':''}} : {{item1.content}} </p>
                        </li>
                      </ul>
                    </div>
                  </div>
                </section>
                <footer style="text-align:end;">
                  <!-- <Page  show-total :total="100" show-elevator /> -->
                  <Page :total="msgTotal" :page-size="pageSizeStu" :page-size-opts="[10,50,100]"  @on-page-size-change="miPageSizeUpdate" placement="top" @on-change="miPageUpdate" show-sizer show-total/>
                </footer>
              </footer>
            </footer>
            <Modal v-model="noPartIn" width="720">
                <p slot="header" style="text-align:left">
                    <span>未参与名单({{dontPartNum}}人)</span>
                </p>
                <div style="display:flex;flex-wrap: wrap;">
                 <span v-for="(item,index) in dontPartIn" :key="index" style="margin-left:20px;"><i class="fa fa-user" style="margin-right:5px;font-size: 20px;color:#3472FB;"></i> {{item.stuName}} </span>
                </div>
                <div slot="footer" style="text-align:left;">
                  <Button type="primary" @click="chaseStu" >催一催</Button>
                </div>
            </Modal>
            <Modal v-model="hurryAlongFlag"  width="786">
                <p slot="header" style="text-align:left">
                    <span>编辑</span>
                </p>
                <div style="text-align:center;height:300px;width:754px;padding:90px;">
                  <div style="background-color:#FFEDE6;height:calc(100%);width:calc(100%);display: flex;align-items: center;justify-content: center;">
                      您将删除本条讨论记录，删除后将不可恢复，确定要删除么？
                  </div>
                </div>
                <div slot="footer" style="text-align:center">
                    <Button type="primary" >确认</Button>
                    <Button @click="hurryAlongFlag = false">取消</Button>   
                </div>
            </Modal>
            <Modal v-model="commentFlag"  width="786">
                <p slot="header" style="text-align:left">
                    <span>评论</span>
                </p>
                <div style="">
                  <Input v-model="ringWorld" type="textarea" :autosize="{minRows: 4,maxRows: 5}" placeholder="请输入评论最多1000字" maxlength="1000" show-word-limit/>
                </div>
                <div slot="footer" style="text-align:center">
                    <Button type="primary" @click="review()" :disabled='reviewFlag'>确认</Button>
                    <Button @click="commentFlag = false">取消</Button>   
                </div>
            </Modal>
            <Modal v-model="ringSomeoneFlag"  width="786">
                <p slot="header" style="text-align:left">
                    <span>回复{{beReivewStuName}}</span>
                </p>
                <div style="">
                  <Input v-model="ringSomeoneWorld" type="textarea" :autosize="{minRows: 4,maxRows: 5}" placeholder="请输入评论最多1000字" maxlength="1000" show-word-limit/>
                </div>
                <div slot="footer" style="text-align:center">
                    <Button type="primary" @click="reviewSomeone()" :disabled='reviewFlag'>确认</Button>
                    <Button @click="ringSomeoneFlag = false">取消</Button>   
                </div>
            </Modal>
            <imgViewer ref="imgViewer"></imgViewer>
          </div>
        </div>
    </div>

</template>


<script>
import myStorge from "../../utils/localStorge.js";
import UEditor from "@/components/ueditor/ueditor.vue";
import fileupload from "@/components/fileupload/fileupload.vue";

import fileNameMatch from "../../utils/fileNameMatch.js";

import imgViewer from "@/components/imgViewer.vue";
export default {
  components: {
    UEditor,
    fileupload,
    imgViewer
  },
  props: {
    beforeViewFlag: {
      type: Boolean,
      default: () => {
        return false;
      }
    }
  },
  data() {
    const _this = this;
    return {
      tabName: myStorge.get("teaCurIndex"),
      discStore: myStorge.get("mission"),
      editDisc: {
        name: "",
        content: ""
      },
      stuDiscussList: [],
      noPartIn: false,
      hurryAlongFlag: false,
      commentFlag: false,
      discFiles: {
        photos: [],
        videos: [],
        audios: []
      },
      classes: [],

      partIn: [],
      dontPartIn: [],
      dontPartNum: 0,
      partNum: 0,

      uploadFile: [],
      teaSay: "",
      teaViewpointer: "",
      showClass: null,
      msgTotal: 0,
      pageSizeStu: 10,
      pageNoStu: 0, //页面从0开始

      ringSomeoneFlag: false,

      beRingedStuParams: null, //被回复的学生
      beReivewStuName: "", //被回复人的名字
      ringSomeoneWorld: "", //评价的语句

      viewPointer: false, //上传时关闭按钮

      stuDiscId: null, //讨论的ID

      ringWorld: "", //评论语句

      reviewFlag: false
    };
  },
  mounted() {
    const _this = this;
    _this.getDiscInfo();
  },
  methods: {
    showImg(params) {
      const _this = this;
      _this.$refs.imgViewer.show(_this.genImages(params));
    },
    genImages(url) {
      const sourceImages = [];
      const base = Math.floor(Math.random() * 60, 10) + 10;
      sourceImages.push({
        thumbnail: url,
        source: url
      });

      return sourceImages;
    },
    setStu(item) {
      this.beRingedStuParams = {
        stuDiscussionsId: item.id,
        content: ""
      };
      // console.log(this.beRingedStuParams);
    },
    studentUpload(flag) {
      this.viewPointer = flag;
    },
    review() {
      this.beRingedStuParams.content = this.ringWorld;
      this.stuRing();
    },
    reviewSomeone() {
      const _this = this;
      _this.beRingedStuParams.content = _this.ringSomeoneWorld;
      _this.stuRing();
    },
    stuRing() {
      const _this = this;
      _this.reviewFlag = true;
      if (_this.beRingedStuParams.content == "") {
        _this.reviewFlag = false;
        return;
      }
      _this.$api.post(
        APIConfig.Review.AddReview,
        this.beRingedStuParams,
        resp => {
          if (resp.code == 0) {
            _this.reviewFlag = false;
            _this.ringSomeoneWorld = "";
            _this.ringWorld = "";
            _this.commentFlag = false;
            _this.ringSomeoneFlag = false;
            _this.getClassInfo();
          } else {
            _this.$Message.info(resp.msg);
          }
        }
      );
    },
    ringSomeone(item) {
      const _this = this;
      _this.ringSomeoneFlag = true;
      _this.beReivewStuName = item.name;
      _this.beRingedStuParams = {
        stuDiscussionsId: item.stuDiscussionsId,
        content: "",
        reviewedName: item.name,
        reviewedType: item.type
      };
    },
    getFiles(files) {},
    getFileIds(fileIds) {
      this.uploadFile = [...fileIds];
    },

    getDiscId() {
      const _this = this;
      _this.$api.get(
        APIConfig.StuDiscussion.GetMyStuByDiscussIdAndClassId,
        {
          discussionId: _this.editDisc.id,
          classId: +_this.showClass.classId
        },
        resp => {
          if (resp.code == 0) {
            _this.stuDisId = resp.data.stuDiscussInfo;
          } else {
            _this.$Message.inof(resp.msg);
          }
        }
      );
    },
    commitTeaDisc() {
      const _this = this;
      _this.viewPointer = true;
      if (_this.teaViewpointer == "" && _this.uploadFile.length == 0) {
        _this.viewPointer = false;
        return;
      }
      _this.$api.post(
        APIConfig.StuDiscussion.CommitStuDiscuss,
        {
          stuDisId: _this.stuDisId.id,
          discussionId: _this.editDisc.id,
          content: _this.teaViewpointer,
          fileIds:
            _this.uploadFile.length == 0 ? "" : _this.uploadFile.join(",")
        },
        resp => {
          if (resp.code == 0) {
            _this.viewPointer = false;
            _this.teaViewpointer = "";
            _this.$refs.fileUpload.init();
            _this.getClassInfo();
          } else {
            _this.$Message.info(resp.msg);
          }
        }
      );
    },
    refresh() {
      this.getClassInfo();
    },
    teacherSummarization() {
      const _this = this;
      let params = {
        id: _this.editDisc.id,
        teaSay: _this.teaSay
      };
      _this.$api.post(APIConfig.Discussion.UpdateTeaSay, params, resp => {
        if (resp.code == 0) {
          _this.$Message.info("总结提交成功");
          _this.editDisc.teaSay = _this.teaSay;
          // _this.teaSay = ""; //清空教师的总结
        } else {
          _this.$Message.info(resp.msg);
        }
      });
      console.log(params);
    },
    chaseStu() {
      const _this = this;
      let ids = _this.dontPartIn.map(params => {
        return params.stuId;
      });
      ids = ids.join(",");
      console.log(ids);
      _this.$api.post(
        APIConfig.StuDiscussion.ChaseStu,
        { userIds: ids, discussionName: _this.editDisc.name },
        resp => {
          if (resp.code == 0) {
            _this.$Message.info("已经发出催促");
          } else {
            _this.$Message.info(resp.msg);
          }
          _this.noPartIn = false;
        }
      );
    },
    getDis() {
      const _this = this;
      _this.$api.get(
        APIConfig.StuDiscussion.GetDis,
        { discussionId: _this.editDisc.id, classId: _this.showClass.classId },
        resp => {
          if (resp.code == 0) {
            _this.partIn = [...resp.data.DisStu];
            _this.partNum = resp.data.total;
          } else {
            _this.$Message.info(resp.msg);
          }
        }
      );
    },
    getNotDis() {
      const _this = this;
      _this.$api.get(
        APIConfig.StuDiscussion.GetNotDis,
        { discussionId: _this.editDisc.id, classId: _this.showClass.classId },
        resp => {
          if (resp.code == 0) {
            _this.dontPartIn = [...resp.data.notDisStu];
            _this.dontPartNum = resp.data.total;
          } else {
            _this.$Message.info(resp.msg);
          }
        }
      );
    },
    miPageUpdate(page) {
      var _this = this;
      _this.pageNoStu = page - 1; //page从0开始
      _this.getClassInfo();
    },
    miPageSizeUpdate(size) {
      var _this = this;
      _this.pageSizeStu = size;
      _this.getClassInfo();
    },
    showStureview(item) {
      this.showClass = item;
      this.getClassInfo();
    },
    getClassInfo() {
      const _this = this;
      _this.$api.get(
        APIConfig.StuDiscussion.GetStuDiscusses,
        {
          discussId: _this.editDisc.id,
          classId: _this.showClass.classId,
          page: _this.pageNoStu,
          size: _this.pageSizeStu
        },
        resp => {
          if (resp.code == 0) {
            // _this.stuDiscussList = resp.data.stuDiscusses;
            _this.stuDiscussList = resp.data.stuDiscusses.map(item => {
              item.isShow = true;
              if (item.fileList) {
                item.fileList.forEach(params => {
                  if (fileNameMatch.isPicture(params.name)) {
                    params["fileType"] = 1;
                  } else if (fileNameMatch.isVideo(params.name)) {
                    params["fileType"] = 2;
                  } else if (fileNameMatch.isAudio(params.name)) {
                    params["fileType"] = 3;
                  }
                });
              }
              return item;
            });

            _this.msgTotal = +resp.data.totalElements;
            _this.getNotDis();
            _this.getDis();
            _this.getDiscId();
          } else {
            _this.$Message.info(resp.msg);
          }
        }
      );
    },
    getDiscInfo() {
      const _this = this;
      _this.$api.get(
        APIConfig.Discussion.GetDiscussionInfo,
        { id: _this.discStore.id },
        resp => {
          if (resp.code == 0) {
            _this.editDisc = resp.data.discussion;

            _this.teaSay = resp.data.discussion.teaSay;
            _this.discFiles.photos = resp.data.files.filter(params => {
              return fileNameMatch.isPicture(params.realName);
            });
            _this.discFiles.videos = resp.data.files.filter(params => {
              return fileNameMatch.isVideo(params.realName);
            });
            _this.discFiles.audios = resp.data.files.filter(params => {
              return fileNameMatch.isAudio(params.realName);
            });
            let className = resp.data.discussion.className.split(",");
            let classIds = resp.data.discussion.classId.split(",");

            //两个数组整合成[{classId:1,className:'1'}]
            const isEmpty = xs => xs.length === 0;
            const head = ([x, ...xs]) => x;
            const tail = ([x, ...xs]) => xs;
            const map = (f, ...xxs) => {
              let loop = (acc, xxs) => {
                if (xxs.some(isEmpty)) return acc;
                else return loop([...acc, f(...xxs.map(head))], xxs.map(tail));
              };
              return loop([], xxs);
            };
            _this.classes = map(
              (classId, className) => ({ classId, className }),
              classIds,
              className
            );

            _this.showClass = _this.classes[0];

            _this.getClassInfo(); //获取第一个班级的信息
          } else {
            _this.$Message.info(resp.msg);
          }
        }
      );
    },
    goback() {
      let path = this.routerCfg.options.pathById(22);
      this.$router.push(path);
    },
    thumbUp(item, index) {
      const _this = this;
      console.log(item);
      if (item.isThumbUp == 1) {
        _this.$api.post(
          APIConfig.Thumb.UpdateThumb,
          {
            thumbId: item.tid,
            isThumbUp: 0
          },
          resp => {
            if (resp.code == 0) {
              this.stuDiscussList[index].isThumbUp = 0;
              this.stuDiscussList[index].thumbsUpNum--;
              this.getClassInfo();
            } else {
              _this.$Message.info(resp.msg);
            }
          }
        );
      } else if (item.isThumbUp == 0) {
        _this.$api.post(
          APIConfig.Thumb.UpdateThumb,
          {
            thumbId: item.tid,
            isThumbUp: 1
          },
          resp => {
            if (resp.code == 0) {
              this.stuDiscussList[index].isThumbUp = 1;
              this.stuDiscussList[index].thumbsUpNum++;
              this.getClassInfo();
            } else {
              _this.$Message.info(resp.msg);
            }
          }
        );
      } else {
        _this.$api.post(
          APIConfig.Thumb.AddThumb,
          {
            stuDiscussId: item.id
          },
          resp => {
            if (resp.code == 0) {
              this.stuDiscussList[index].isThumbUp = 1;
              this.stuDiscussList[index].thumbsUpNum++;
              this.getClassInfo();
            } else {
              _this.$Message.info(resp.msg);
            }
          }
        );
      }
    },
    hideReview(item, index) {
      const _this = this;
      const dom = document.querySelector(".re" + index);
      if (item.isShow) {
        $(dom).hide("slow");
        item.isShow = false;
      } else {
        $(dom).show("slow");
        item.isShow = true;
      }
      console.log(dom);
    }
  }
};
</script>


<style lang="scss" scoped>
.miss {
  width: 250px;
  margin-right: 20px;
}
.other-contents {
  min-width: 1276px;
  //   overflow: auto;
  > footer {
    // overflow: auto;
    margin: 20px 30px;
  }
}
.other-contents > header {
  padding: 20px;
  border-bottom: 1px solid #eee;
  .add-btn {
    color: #fff;
    background-color: #51aafe;
    border-color: #51aafe;
  }
}
.activeClass {
  background-color: #fff;
  border-top: 2px solid #4fadfe;
}

.thumbs-active {
  color: red;
}

*/deep/ .ivu-input[disabled],
fieldset[disabled] .ivu-input {
  background-color: #fff;
  opacity: 1;
  cursor: not-allowed;
  color: #000;
}
</style>
